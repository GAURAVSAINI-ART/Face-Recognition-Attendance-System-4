<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Sentinel | Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --neon-cyan: #22d3ee; --neon-red: #ef4444; --dark: #020617; }
        body { background: radial-gradient(circle at center, #1e293b, #020617); color: white; font-family: 'Rajdhani', sans-serif; min-height: 100vh; margin: 0; padding: 20px; }
        .glass-card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .video-wrapper { position: relative; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 20px; overflow: hidden; border: 2px solid var(--neon-cyan); background: #000; aspect-ratio: 4/3; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: var(--neon-cyan); box-shadow: 0 0 20px var(--neon-cyan); z-index: 10; display: none; }
        .scanning-active .scanline { display: block; animation: scanning 2.5s ease-in-out infinite; }
        @keyframes scanning { 0%, 100% { top: 0%; } 50% { top: 100%; } }
        .face-bracket { position: absolute; width: 30px; height: 30px; border: 3px solid var(--neon-cyan); z-index: 11; opacity: 0.5; }
        .status-box { font-family: 'Orbitron'; color: var(--neon-cyan); margin: 15px 0; min-height: 30px; letter-spacing: 1px; }
        .count-display { font-family: 'Orbitron'; font-size: 2.5rem; color: var(--neon-cyan); text-shadow: 0 0 15px var(--neon-cyan); }
        .btn-neon { border-radius: 50px; padding: 10px 20px; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        .log-container { max-height: 200px; overflow-y: auto; }
        @media (min-width: 992px) { .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items:center mb-4">
            <h1 style="font-family:'Orbitron'; color:var(--neon-cyan); font-size:1.5rem;">AI ATTENDANCE</h1>
            <button id="toggleBtn" onclick="toggleCamera()" class="btn btn-outline-success btn-neon">START CAMERA</button>
        </div>

        <div class="main-grid">
            <div class="glass-card text-center mb-4">
                <div class="video-wrapper" id="vWrap">
                    <div class="scanline"></div>
                    <div class="face-bracket" style="top:20px;left:20px;border-right:0;border-bottom:0;"></div>
                    <div class="face-bracket" style="top:20px;right:20px;border-left:0;border-bottom:0;"></div>
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="canvas" hidden></canvas>
                </div>
                <div id="status" class="status-box">SYSTEM READY</div>
                <div class="d-flex justify-content-center gap-2">
                    <a href="/download" class="btn btn-outline-info btn-neon"><i class="bi bi-download"></i> CSV</a>
                    <button onclick="clearAttendance()" class="btn btn-outline-danger btn-neon"><i class="bi bi-trash"></i> RESET</button>
                </div>
            </div>

            <div class="side-panel">
                <div class="glass-card text-center mb-3">
                    <div class="small opacity-50 font-monospace">PRESENT TODAY</div>
                    <div id="count" class="count-display">0</div>
                </div>
                <div class="glass-card">
                    <h6 class="small mb-3 font-monospace text-info">RECENT ACTIVITY</h6>
                    <div id="logs" class="log-container small"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById("video"), canvas = document.getElementById("canvas"), 
              status = document.getElementById("status"), logs = document.getElementById("logs"),
              vWrap = document.getElementById("vWrap"), toggleBtn = document.getElementById("toggleBtn");
        let stream = null, isCapturing = false;

        function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.rate=1.1; window.speechSynthesis.speak(m); }

        async function toggleCamera() {
            if (!stream) {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream; isCapturing = true;
                vWrap.classList.add("scanning-active");
                toggleBtn.innerText = "STOP CAMERA"; toggleBtn.className = "btn btn-outline-danger btn-neon";
            } else {
                stream.getTracks().forEach(t => t.stop()); stream = null; isCapturing = false;
                vWrap.classList.remove("scanning-active");
                toggleBtn.innerText = "START CAMERA"; toggleBtn.className = "btn btn-outline-success btn-neon";
                status.innerText = "SYSTEM STOPPED";
            }
        }

        setInterval(() => {
            if (!isCapturing || video.videoWidth === 0) return;
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            fetch("/process_frame", { method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: canvas.toDataURL("image/jpeg", 0.7) })
            }).then(r => r.json()).then(d => {
                status.innerText = d.status.toUpperCase();
                if (d.status.includes("Success")) {
                    let name = d.status.split(": ")[1];
                    if (status.dataset.last !== name) {
                        status.dataset.last = name; speak("Welcome " + name);
                        const row = document.createElement("div"); row.innerHTML = `âœ” ${name} - ${new Date().toLocaleTimeString()}`;
                        logs.prepend(row); updateCount();
                    }
                } else if (d.status === "Scanning...") { status.dataset.last = ""; }
            });
        }, 1000);

        function updateCount() { fetch('/get_count').then(r => r.json()).then(d => document.getElementById('count').innerText = d.count); }
        function clearAttendance() {
            const p = prompt("Password:");
            fetch("/clear_logs", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ password: p }) })
            .then(r => r.ok ? (logs.innerHTML="", updateCount(), alert("Cleared")) : alert("Denied"));
        }
        updateCount();
    </script>
</body>
</html>